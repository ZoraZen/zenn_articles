---
title: "Pythonã®structlogã‚’ä½¿ã„ã“ãªã™"
emoji: "ğŸ—‚"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["python", "log", "logger", "structlog"]
published: true
---

# è¨˜äº‹ã®å†…å®¹

- Pythonè¨€èªã«ãŠã‘ã‚‹ `structlog` ã®ç´¹ä»‹
- `structlog` ã®ä½¿ã„æ–¹ã®è§£èª¬
- ç§ã®è¨­å®šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®å…±æœ‰ã¨è§£èª¬

# ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³

- `structlog` ã®ä½¿ã„æ–¹ã«é–¢ã™ã‚‹æƒ…å ±ãŒãƒãƒƒãƒˆã«ãªã„ã®ã§æ›¸ã
- `structlog` ã®ä½œè€…ã¸ã®å¯„ä»˜é‡‘ãŒå¢—ãˆã¦ã»ã—ã„ã€ã¨ã„ã†ç¥ˆã‚Š
- `structlog` ãŒPythonã®loggerãƒ„ãƒ¼ãƒ«ã®ä¸­ã§ä¸€ç•ªä½¿ã„å‹æ‰‹ãŒã‚ˆã„ã€ã¨ã„ã†å®—æ•™æˆ¦äº‰


# `structlog` ã«ã¤ã„ã¦

`structlog` ã¯Pythonã®ãƒ­ã‚®ãƒ³ã‚°ã‚’æ”¹å–„ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¼ã§ã‚ã‚Šã€ä¸€è²«æ€§ã®ã‚ã‚‹ç°¡æ˜“ãªAPIã¨ `æ§‹é€ åŒ–ãƒ­ã‚®ãƒ³ã‚°ï¼ˆStructured Loggingï¼‰` ã‚’æ¡ç”¨ã—ã¦ã„ã‚‹ç‚¹ã«ç‰¹å¾´ãŒã‚ã‚‹ã€‚
ä½œè€…ã¯[attrs](https://github.com/python-attrs/attrs)ã®ä½œè€…ã¨ã—ã¦æœ‰åãª[hynek(Hynek Schlawack)](https://github.com/hynek)ã€‚^[ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚‚ `Hynek` ãŒè¡Œã£ã¦ã„ã‚‹]

## æ§‹é€ åŒ–ãƒ­ã‚®ãƒ³ã‚°ã«ã¤ã„ã¦

structlogãŒå®Ÿç¾ã—ã¦ã„ã‚‹ `æ§‹é€ åŒ–ãƒ­ã‚®ãƒ³ã‚°(Structured logging)` ã«ã¤ã„ã¦ã¯[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://www.structlog.org/en/stable/why.html)ã§ä»¥ä¸‹ã®ã‚ˆã†ã«èª¬æ˜ã•ã‚Œã¦ã„ã‚‹ã€‚

```markdown
Structured logging means that you donâ€™t write hard-to-parse and
hard-to-keep-consistent prose in your log entries. Instead, you log events that
happen in a context of key-value pairs.

# æ§‹é€ åŒ–ãƒ­ã‚®ãƒ³ã‚°ã¨ã¯ã€ãƒ‘ãƒ¼ã‚¹ãŒé›£ã—ãã€ä¸€è²«æ€§ã‚’ä¿ã¡é›£ã„å¹³æ–‡ã‚’ãƒ­ã‚°ã«æ›¸ãã®ã‚’å›é¿ã—ã€
# ä»£ã‚ã‚Šã«èµ·ããŸã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚­ãƒ¼ã¨å€¤ã®ãƒšã‚¢å½¢å¼ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«ã—ã¦ãƒ­ã‚°ã«æ®‹ã™æ‰‹æ³•ã§ã™ã€‚
```

Pythonã®loggerãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä¸Šã§ã‚‚æ§‹é€ åŒ–ãƒ­ã‚°ã¯å®Ÿç¾ã§ãã‚‹ãŒã€structlogã¯æœ€åˆã‹ã‚‰æ§‹é€ åŒ–ãƒ­ã‚°ã«ç‰¹åŒ–ã—ãŸAPIãŒç”¨æ„ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã«ç‰¹å¾´ãŒã‚ã‚‹ã€‚

## `structlog` ã‚’ä½¿ã†ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³

### structlogã®åˆ©ç‚¹

structlogã®åˆ©ç‚¹ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å†’é ­ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã€‚
ä»¥ä¸‹ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å†’é ­ã¨ãã‚Œã‚’ç¿»è¨³ã—ãŸã‚‚ã®ã€‚

```markdown
structlog is the production-ready logging solution for Python:
# structlogã¯æœ¬ç•ªç’°å¢ƒã§ã‚‚å®‰å®šã—ã¦å‹•ãPythonã®ãƒ­ã‚®ãƒ³ã‚°ã®è§£æ±ºç­–ã§ã™
# ãã®ç‰¹å¾´ã¯ã‚·ãƒ³ãƒ—ãƒ«ã•ã¨ãƒ‘ãƒ¯ãƒ•ãƒ«ã•ã€å®Ÿè¡Œé€Ÿåº¦ã«ã‚ã‚‹ã€‚

Simple: At its core, everything is about functions that take and return
dictionaries â€“ all hidden behind familiar APIs.
# ã‚·ãƒ³ãƒ—ãƒ«ã•
# æ©Ÿèƒ½ã®ä¸­å¿ƒã¯è¾æ›¸ãƒ‡ãƒ¼ã‚¿ã®å—ã‘æ¸¡ã—ã®é–¢æ•°ã§ã‚ã‚Šã€Pythonã®æ¨™æº–çš„ãªAPIã§æ“ä½œã§ãã¾ã™ã€‚

- Powerful: Functions and dictionaries arenâ€™t just simple, theyâ€™re also
  powerful. structlog leaves you in control.
# ãƒ‘ãƒ¯ãƒ•ãƒ«ã•
# ã‚·ãƒ³ãƒ—ãƒ«ãªé–¢æ•°ã¨è¾æ›¸ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¹ã¯ã€åŒæ™‚ã«é«˜ã„æ©Ÿèƒ½æ€§ãƒ»æ‹¡å¼µæ€§ã‚’ã‚‚æŒã¡åˆã‚ã›ã¦ã„ã¾ã™ã€‚
# structlogã¯ã€ç´°ã‹ãªæŒ™å‹•ã«è‡³ã‚‹ã¾ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‹•ä½œã‚’åˆ¶å¾¡ã§ãã¾ã™ã€‚

Fast: structlog is not hamstrung by designs of yore. Its flexibility comes not
at the price of performance.
# å®Ÿè¡Œé€Ÿåº¦
# structlogã¯ã€Pythonã®å¤ã„ãƒ­ã‚®ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ã®åˆ¶ç´„ã«ç¸›ã‚‰ã‚Œãªã„é«˜ã„æŸ”è»Ÿæ€§ã‚’æŒã£ã¦ã„ã¾ã™ã€‚
# ã—ã‹ã‚‚ãã®æŸ”è»Ÿæ€§ã¯ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’çŠ ç‰²ã«ã™ã‚‹ã“ã¨ãªãå®Ÿç¾ã•ã‚Œã¦ã„ã¾ã™ã€‚
```

## ä»–ãƒ„ãƒ¼ãƒ«ã¨ã®æ¯”è¼ƒ

- è‘—è€…ã®ä¸»è¦³ã§ä»–ã®ãƒ­ã‚¬ãƒ¼ãƒ„ãƒ¼ãƒ«(`loggerãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«`^[Pythonã«å«ã¾ã‚Œã¦ã„ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨ã—ã¦ã®logger]ã¨`logru`^[[Delgan/loguru: Python logging made (stupidly) simple](https://github.com/Delgan/loguru)])ã¨structlogã®æ¯”è¼ƒã‚’ã™ã‚‹

:::message
ã‚ãã¾ã§ä¸»è¦³ã§ã™
:::

### 1. Pythonã®loggerãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« vs structlog

```markdown
- loggerãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®åˆ©ç‚¹
  - Pythonã®ãƒ“ãƒ«ãƒˆã‚¤ãƒ³ã§ã‚ã‚‹ãŸã‚ã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å°å…¥ã™ã‚‹å¿…è¦ãŒãªã„ã€‚
- loggerãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®æ¬ ç‚¹
  - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è§£èª­ã™ã‚‹ã®ã«æ•°æ—¥ã‹ã‹ã‚‹
  - æ­£ã—ãä½¿ã†ã®ã«ã•ã‚‰ã«æ•°æ—¥ã‹ã‹ã‚‹
```

### 2. logru vs structlog

```markdown
- logruã®åˆ©ç‚¹
  - å°å…¥æ–¹æ³•ãŒã‚·ãƒ³ãƒ—ãƒ«ã§logã‚’æˆåŠŸã•ã›ã‚‹ã¾ã§ã¯æœ€é€Ÿã€‚
  - structlogã¯ä½¿ã„å§‹ã‚ã«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä¸€æ™‚é–“ãã‚‰ã„èª­ã‚€å¿…è¦ãŒã‚ã‚‹ã€‚
- logruã®æ¬ ç‚¹
  - logruã¯ç¾çŠ¶ã§ã¯loggerãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®è–„ã„ãƒ©ãƒƒãƒ‘ãƒ¼ãªã®ã§ã€æ·±å…¥ã‚Šã™ã‚‹ãªã‚‰æ‰‹é–“ã¯loggerãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨å¤‰ã‚ã‚‰ãªã„ã€‚
  - structlogã¯è¨­å®šã‚’å¤‰æ›´ã™ã‚‹ã®ãŒæ®µé•ã„ã«ç°¡å˜ã€‚
  - structlogã¯loggerãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ©ãƒƒãƒ‘ãƒ¼ã¨ã—ã¦ä½¿ã†ã“ã¨ã‚‚ã§ãã‚‹ã€‚
  - ãã®å ´åˆã§ã‚‚è¨­å®šã¯structlogã®APIã‚’é€šã˜ã¦è¨˜è¼‰ã™ã‚‹ã“ã¨ãŒã§ãloggerãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®APIã«æ·±å…¥ã‚Šã›ãšã«æ¸ˆã‚€ã€‚
```

# æœ¬é¡Œ

logruã¨æ¯”è¼ƒã™ã‚‹ã¨å°å…¥ã®æ•·å±…ãŒé«˜ã„ã€ãã‚ŒãŒstructlogã®æ¬ ç‚¹ã§ã‚ã‚‹ã€‚
logruã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒšã™ã‚‹ã ã‘ã§å‹•ããŒã€structlogã«ã¯ç°¡å˜ãªãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãŒãªããƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚‚é›£ã—ã„ã€‚^[ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã€ã‚ã‚‹ã«ã¯ã‚ã‚‹ãŒã€ã‹ãªã‚Šä¸Šç´šè€…å‘ã
[Getting Started - structlog 23.1.0 documentation](https://www.structlog.org/en/stable/getting-started.html)]
ãã®ãŸã‚ã€æœ¬è¨˜äº‹ã§ç°¡å˜ãªstructlogã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã¨ç§ã®structlogã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å…±æœ‰ã™ã‚‹ã€‚

## ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«

![ä½¿ã„æ–¹ã®ç”»åƒ](/images/5e84bf93f37b1b/log_tutorial.png) 
*ã“ã‚Œã‚’è¦‹ã‚ã€‚ä»¥ä¸Š*

## ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã®ã‚³ãƒ¼ãƒ‰éƒ¨åˆ†

```python
import structlog

# æœ€åˆã¯logã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‘¼ã³å‡ºã™ã“ã¨ã‹ã‚‰å§‹ã‚ã‚‹ã€‚
# bindã‚’ä½¿ã„ã€logã‚’ã‚­ãƒ¼ã¨å€¤ã®çµ„åˆã›ã§æ§‹é€ åŒ–ã—ã¦ã„ã‚‹ã€‚
mylog = structlog.get_logger().bind(purpose="Tutorial")

# lesson="one"ã§infoã®å†…å®¹ã‚’æ§‹é€ åŒ–ã—ã¦ã„ã‚‹ã€‚
# bindã§æ§‹é€ åŒ–ã•ã‚ŒãŸå†…å®¹ã¯unbindã•ã‚Œãªã„é™ã‚Šã€ä¿æŒã•ã‚Œç¶šã‘ã‚‹ã€‚
# "hello, world"ãŠã‚ˆã³lesson="one"ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¯æ¬¡ã®ãƒ­ã‚°ã«ã¯ä¿æŒã•ã‚Œãªã„ã€‚(ä¸€åº¦ãã‚Š)
mylog.info("hello, world", lesson="one")

# è¤‡æ•°ã®æ§‹é€ ã‚’æŒãŸã›ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚
mylog.info("good bye", lesson="two", feel="sad")

# è¤‡æ•°ã®logã‚’å®šç¾©ã—ä¸¦åˆ—ã§ä½¿ã†ã“ã¨ãŒã§ãã‚‹ã€‚
second_log = structlog.get_logger().bind(target="multi_log_tutorial")

# æ·±åˆ»åº¦ã«å¿œã˜ã¦å‡ºåŠ›å½¢å¼ã€debug, info, warning, error, criticalã‚’ä½¿ã„åˆ†ã‘ã‚‹
# https://docs.python.org/ja/3/library/logging.html#logging-levels
second_log.warn("it is second logger")

# æ–‡å­—åˆ—å‹ä»¥å¤–ã‚‚æ§‹é€ ã«å…¥ã‚Œã‚‰ã‚Œã‚‹ã€‚
second_log.error("Error Trial", is_danger=False)

# second_logã¨mylogã¯å…±å­˜ã§ãã‚‹ã€‚
mylog.info("First log is still alive", lesson="last")
```

## ç§ã®structlogãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

ä¸Šã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ã¯structlogã®åˆæœŸè¨­å®šã®æŒ™å‹•ã‚’ãã®ã¾ã¾ä½¿ç”¨ã—ã¦ã„ã‚‹ã€‚
structlogã«ã¯æŒ™å‹•ã®å¤‰æ›´ã®ä½™åœ°ãŒç„¡é™ã«æ®‹ã•ã‚Œã¦ã„ã‚‹ã€‚ã¾ãŸå…¬å¼æ¨å¥¨ã®ã‚ªã‚¹ã‚¹ãƒ¡è¨­å®šã®ã‚ˆã†ãªã‚‚ã®ã¯ãªã„ã€‚
ãã“ã§è¨­å®šã®ä¸€ä¾‹ã¨ã—ã¦ç§ãŒä½¿ç”¨ã—ã¦ã„ã‚‹è¨­å®šã®çµ„ã¿åˆã›(ä»¥ä¸‹ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ)ã‚’å…±æœ‰ã—ã€ãã®å‹•ã‹ã—æ–¹ã¨ä»•æ§˜ã‚’è§£èª¬ã™ã‚‹ã€‚

```python:logger_config.py
"""logger_config.py: This module configures the logging.
This module uses structlog to configure logging.
"""
import logging
import sys

import structlog
from structlog.dev import ConsoleRenderer
from structlog.processors import JSONRenderer


def configure_logger():
    """
    Configures the global logging settings for the application using structlog and Python's built-in logging module.

    This function applies various processors to the logs, including adding log level, logger name, and timestamp,
    rendering stack information, decoding unicode, and wrapping the message for formatter. The logs are output in
    both console and a file named "application.log". Console logs are formatted for readability while the file logs are
    in JSON format for further processing.

    It is recommended to call this function only once at the start of the application.

    Notes
    -----
    The log level is set to INFO, meaning that INFO and above level logs (WARNING, ERROR, CRITICAL) are recorded.

    The configuration includes a `cache_logger_on_first_use` setting to improve performance by caching the logger
    on its first use.

    The standard output (stdout) and a file "application.log" are used as log outputs. If "application.log"
    already exists, new logs will be appended to the existing file.
    """
    structlog.configure(
        processors=[
            structlog.stdlib.add_log_level,
            structlog.stdlib.add_logger_name,
            structlog.stdlib.PositionalArgumentsFormatter(),
            structlog.processors.TimeStamper(fmt="%Y-%m-%d %H:%M.%S", utc=False),
            structlog.processors.StackInfoRenderer(),
            structlog.processors.UnicodeDecoder(),
            structlog.stdlib.ProcessorFormatter.wrap_for_formatter,
        ],
        logger_factory=structlog.stdlib.LoggerFactory(),
        wrapper_class=structlog.stdlib.BoundLogger,
        cache_logger_on_first_use=True,
    )
    handler_stdout = logging.StreamHandler(sys.stdout)
    handler_stdout.setFormatter(structlog.stdlib.ProcessorFormatter(processor=ConsoleRenderer()))

    handler_file = logging.FileHandler("application.log")
    handler_file.setFormatter(structlog.stdlib.ProcessorFormatter(processor=JSONRenderer()))

    root_logger = logging.getLogger()
    root_logger.addHandler(handler_stdout)
    root_logger.addHandler(handler_file)
    root_logger.setLevel(logging.INFO)
```

### å‹•ã‹ã—æ–¹

ã¾ãšã€ä¸Šã®å†…å®¹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’`logger_config`ã¨ã—ã¦ä¿å­˜ã™ã‚‹ã€‚ãã—ã¦`main.py`ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ä½œæˆã—å®Ÿè¡Œã™ã‚‹ã€‚

```python:main.py
from logger_config import configure_logger

configure_logger()
log = structlog.get_logger()
log.info("hello, world")
```

`get_logger()`ã‚’ã™ã‚‹å‰ã«`configuer_logger()`ã‚’å‘¼ã¶ã“ã¨ã«ã‚ˆã£ã¦`get_logger()`ã®å‡¦ç†ãŒã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã•ã‚ŒãŸloggerã‚’å‘¼ã¶ã‚ˆã†ã«ãªã‚‹ã€‚

## ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè§£èª¬

### ç§ãŒã“ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§å®Ÿç¾ã—ãŸã“ã¨

- ç›®çš„1: ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ä¸Šã®logã®è¡¨ç¤ºã‚’ç¶ºéº—ã«ã™ã‚‹ã“ã¨
- ç›®çš„2: logã®çµæœã‚’ `aplication.log` ã«jsonå½¢å¼ã§ä¿å­˜ã™ã‚‹ã“ã¨
- ç›®çš„3: æƒ…å ±ã‚’ã§ãã‚‹é™ã‚Šæ§‹é€ åŒ–ã—ã¦è¡¨ç¤ºã™ã‚‹ã“ã¨

### é”æˆã—ãªã„ã“ã¨

1. ã‚¯ãƒ©ã‚¦ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ­ã‚°ç®¡ç†ãƒ„ãƒ¼ãƒ«ã¨ã®é€£æº
2. ELKã‚¹ã‚¿ãƒƒã‚¯ãªã©ã®ä¸­å¤®ãƒ­ã‚°ç®¡ç†ãƒ„ãƒ¼ãƒ«ã¨ã®é€£æº
3. loggingå‡¦ç†ã®é«˜é€ŸåŒ–ãƒ»ä¸¦åˆ—å‡¦ç†ã®å®Ÿè£…
4. logã®åœ§ç¸®ä¿å­˜

ã“ã®è¨˜äº‹ã§ã¯ã“ã‚Œã‚‰ã®è¦ç´ ã«ã¤ã„ã¦è¨€åŠã—ãªã„ãŒ1ã¨2ã«ã¤ã„ã¦ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¯è¨˜è¼‰ãŒã‚ã‚‹ã€‚^[[Logging Best Practices - structlog 23.1.0 documentation](https://www.structlog.org/en/stable/logging-best-practices.html)]

### è©³ç´°è§£èª¬

- ãƒ‘ãƒ¼ãƒˆ1

```python:logger_config.py
handler_stdout = logging.StreamHandler(sys.stdout)
handler_stdout.setFormatter(structlog.stdlib.ProcessorFormatter(processor=ConsoleRenderer()))

handler_file = logging.FileHandler("application.log")
handler_file.setFormatter(structlog.stdlib.ProcessorFormatter(processor=JSONRenderer()))

root_logger = logging.getLogger()
root_logger.addHandler(handler_stdout)
root_logger.addHandler(handler_file)
```

`ç›®çš„1ã¨ç›®çš„2` ã®ãŸã‚ã« `handler_stdout` ã¨ `handler_file` ã‚’structlogä¸Šã§ç”¨æ„ã—ã€ãã‚Œã‚’Pythonã®loggerãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«æ¸¡ã™ã€‚

`handler_stdout` ã«ã¯ `ConsoleRenderer` ã‚’ `handler_file` ã«ã¯ `JSONRenderer` ã‚’ã‚»ãƒƒãƒˆã™ã‚‹ã€‚
`JSONRenderer` ã«ã‚ˆã£ã¦ãƒ­ã‚°ã¯'application.log'ã«"json"å½¢å¼ã§ä¿å­˜ã•ã‚Œã‚‹ã€‚
`ConsoleRenderer` ã¯ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ä¸Šã§ãƒ­ã‚°ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã®è¨­å®šã§ã‚ã‚‹ã€‚
ãŸã è¡¨ç¤ºã™ã‚‹ã®ã¿ãªã‚‰ãšã€Pythonã®CUIè¡¨ç¤ºã‚’æ”¹å–„ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã‚ã‚‹ `colorama`^[Windowsç’°å¢ƒã®ã¿æœ‰åŠ¹]ã¨ `better-exception` ã€ `Rich` ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚Œã°ã€ãã‚Œã‚‰ãŒä½¿ç”¨ã•ã‚Œå¯èª­æ€§ãŒå‘ä¸Šã™ã‚‹ã€‚

--- 

- ãƒ‘ãƒ¼ãƒˆ2
  ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‹ã‚‰ã®é•ã„ã¨ã—ã¦`structlog.stdlib.add_logger_name`ã®è¿½åŠ ãŒã‚ã‚‹ã€‚
  ã“ã‚Œã¯`ç›®çš„3`ã‚’é”æˆã™ã‚‹ãŸã‚ã«è¿½åŠ ã—ãŸã€‚

```diff python:logger_config.py
processors=[
    ...
+   structlog.stdlib.add_logger_name,
    ...
    ]
```

ã“ã‚Œã«ã‚ˆã‚Šã€logã‚’å®šç¾©ã™ã‚‹éš›ã«åå‰ã‚’ä»˜ä¸ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã‚‹ã€‚

```diff python
- log = get_logger()
- log.bind(name="log_name")
+ log = get_logger('log_name')
```

## ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ä½¿ç”¨ä¾‹

ä»¥ä¸‹ã¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ç”¨ã—ãŸãƒ­ã‚°ã®å–ã‚Šæ–¹ã®ä¾‹ã§ã‚ã‚‹ã€‚
è§£èª¬ã‚’å¾Œè¿°ã™ã‚‹ã€‚

```python:main.py
import asyncio
import uuid
import structlog

from logger_config import configure_logger
from strategies import StrategyA
from strategies import StrategyB
from strategies import StrategyC


async def main():
    configure_logger()

    run_id = str(uuid.uuid4())
    log = structlog.get_logger(__name__).bind(run_id=run_id)

    strategy_a = StrategyA(run_id)
    strategy_b = StrategyB(run_id)
    strategy_c = StrategyC(run_id)

    try:
        await asyncio.gather(
            strategy_a.execute(),
            strategy_b.execute(),
            strategy_c.execute(),
        )
    except Exception as e:
        log.exception("An error occurred inside asyncio gather", exception=str(e))
    log.info("Application finished.")


if __name__ == "__main__":
    asyncio.run(main())
```

```python:strategies.py
import asyncio
import inspect
import structlog


class StrategyA:
    def __init__(self, run_id):
        self.run_id = run_id
        self.log = structlog.get_logger(__name__).bind(
            run_id=self.run_id,
            strategy_name=self.__class__.__name__,
        )

    async def execute(self):
        self.log.info("Executing strategy A...")
        await asyncio.sleep(2)
        self.log.info("Strategy A execution finished.")


class StrategyB:
    def __init__(self, run_id):
        self.run_id = run_id
        self.log = structlog.get_logger(__name__).bind(
            run_id=self.run_id,
            strategy_name=self.__class__.__name__,
        )

    async def execute(self):
        self.log.info(
            "Executing strategy B...", function_name=inspect.currentframe().f_code.co_name
        )
        await asyncio.sleep(3)
        self.log.info(
            "Strategy B execution finished.", function_name=inspect.currentframe().f_code.co_name
        )


class StrategyC:
    ERROR_MESSAGE = "Something went wrong in StrategyC"

    def __init__(self, run_id):
        self.run_id = run_id
        self.log = structlog.get_logger(__name__).bind(
            run_id=self.run_id,
            strategy_name=self.__class__.__name__,
        )

    async def execute(self):
        try:
            self.log.info("Executing strategy C...")
            await asyncio.sleep(1)
            raise RuntimeError(self.ERROR_MESSAGE)
            self.log.info("Strategy C execution finished.")  # This line will never be reached
        except Exception as e:
            self.log.exception("An error occurred during strategyC execution", exception=str(e))


if __name__ == "__main__":
    from logger_config import configure_logger
    import uuid

    configure_logger()

    run_id = str(uuid.uuid4())

    strategy_a = StrategyA(run_id)
    asyncio.run(strategy_a.execute())
```

```python:test_strategies.py
import pytest
from strategies import StrategyA
from strategies import StrategyB
from strategies import StrategyC


@pytest.fixture()
def run_id():
    return "test_run"


@pytest.mark.asyncio()
async def test_strategyA(capsys, run_id):
    strategy_a = StrategyA(run_id)
    await strategy_a.execute()

    captured = capsys.readouterr()
    assert "Executing strategy A..." in captured.out
    assert "Strategy A execution finished." in captured.out

@pytest.mark.asyncio()
async def test_strategyB(capsys, run_id):
    strategy_b = StrategyB(run_id)
    await strategy_b.execute()
    captured = capsys.readouterr()
    assert "Executing strategy B..." in captured.out
    assert "Strategy B execution finished." in captured.out


@pytest.mark.asyncio()
async def test_strategyC(capsys, run_id):
    strategy_c = StrategyC(run_id)
    await strategy_c.execute()

    captured = capsys.readouterr()
    assert "Executing strategy C..." in captured.out
    assert "An error occurred during strategyC execution" in captured.out
    assert StrategyC.ERROR_MESSAGE in captured.out
```

## å®Ÿè¡Œçµæœ

![main.pyã®å®Ÿè¡Œçµæœ](/images/5e84bf93f37b1b/main_result.png) 
*main.pyã®å®Ÿè¡Œçµæœ*

![strategies.pyã®å®Ÿè¡Œçµæœ](/images/5e84bf93f37b1b/strategyA.png)
*strategies.pyã®å®Ÿè¡Œçµæœ*

![ãƒ†ã‚¹ãƒˆã®çµæœ](/images/5e84bf93f37b1b/pytest_result.png) 
*pytest ã®çµæœ*

## å®Ÿè·µã‚³ãƒ¼ãƒ‰ã®è§£èª¬ã¨è£œè¶³

### ãƒ†ã‚¹ãƒˆã«ã¤ã„ã¦

Pytestã«ã¯loggerã®å‡ºåŠ›ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã™ã‚‹æ©Ÿèƒ½ãŒå‚™ã‚ã£ã¦ãŠã‚Šã€ç§ã¯ãã‚Œã‚’åˆ©ç”¨ã—ã¦ãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ã¦ã„ã‚‹ã€‚

```python:test_strategies.py
captured = capsys.readouterr()
assert "Executing strategy C..." in captured.out
```

### `inspect` ã¨ `CallsiteParameterAdder` ã«ã¤ã„ã¦

```diff python:strategies.py
class StrategyB:
    def __init__(self, run_id):
        self.run_id = run_id
+        self.log = structlog.get_logger(__name__).bind(
            run_id=self.run_id,
+            strategy_name=self.__class__.__name__,
        )

    async def execute(self):
        self.log.info(
+            "Executing strategy B...", function_name=inspect.currentframe().f_code.co_name
        )
        await asyncio.sleep(3)
        self.log.info(
+            "Strategy B execution finished.", function_name=inspect.currentframe().f_code.co_name
        )
```

ä¸Šã®éƒ¨åˆ†ã§ã¯ãƒ­ã‚°ã« `__name__` ã¨ `__class__.__name__` ã¨ `inspect.currentframe().f_code.co_name` ã®å€¤ã‚’è¿½åŠ ã—ã¦ã„ã‚‹ã€‚
ãã‚Œãã‚Œã¯å®Ÿè¡Œæ™‚ã« `strategies` (ã‚ã‚‹ã„ã¯ `__main__` )ã€ `StrategyB` ã€ `excecute` ã¨ã—ã¦è©•ä¾¡ã•ã‚Œã‚‹ã€‚
`structlog.processors.CallsiteParameter` ã§ã‚‚ä¼¼ãŸæ©Ÿèƒ½ã¯å®Ÿè£…ã§ãã‚‹ãŒã€ç§ã¯ä½¿ç”¨ã—ã¦ã„ãªã„ã€‚

### structlogã®asyncæ©Ÿèƒ½ã«ã¤ã„ã¦

ç§ã¯ä½¿ç”¨ã—ã¦ã„ãªã„ãŒã€structlogã«ã¯asyncç”¨ã®æ©Ÿèƒ½ãŒå­˜åœ¨ã™ã‚‹ã€‚
ä½¿ã„æ–¹ã¯ç°¡å˜ã§ã€logã®å®Ÿè¡Œãƒ¡ã‚½ãƒƒãƒ‰ã®å†’é ­ã« `a` ã‚’ã¤ã‘ã‚‹ã ã‘ã§ã‚ã‚‹ã€‚
ã—ã‹ã—ã€ç§ã®å®Ÿè¡Œä¾‹ã®ä¸­ã«ã¯éåŒæœŸã®å‡¦ç†ã¯å«ã¾ã‚Œã¦ã¯ã„ã‚‹ãŒã€structlogã‚’éåŒæœŸå‡¦ç†ã™ã‚‹æ“ä½œã¯å«ã‚“ã§ã„ãªã„ã€‚^[ä»Šå¾Œã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’è¿½æ±‚ã™ã‚‹å¿…è¦ãŒç”Ÿã˜ã‚Œã°å‹•ä½œæ¤œè¨¼ã‚’ã—ã¦ä½¿ç”¨ã™ã‚‹ã¨æ€ã†ãŒä»Šã¯ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ãŒãªã„]

# structlogã®ä»Šå¾Œã¨å¯„ä»˜

## ã‚­ãƒ©ãƒ¼ãƒ„ãƒ¼ãƒ«

ç§ã¯structlogã‚’Pythonã®ã‚­ãƒ©ãƒ¼ãƒ„ãƒ¼ãƒ«ã ã¨è€ƒãˆã¦ã„ã‚‹ã€‚
å…·ä½“çš„ã«ã¯ã€Pythonãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã»ã©ã‚“ã©ãŒæ›¸ã„ãŸã“ã¨ãŒã‚ã‚‹ã§ã‚ã‚ã† `print()` ã¯ `log.info()` ã«ç½®ãä»£ã‚ã‚‹ã¹ãã ã¨è€ƒãˆã¦ã„ã‚‹ã€‚
å¤§ããªã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã¨ãã¯å½“ç„¶ã€å°ã•ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æ›¸ãå ´åˆã§ã‚ã£ã¦ã‚‚structlogã‚’ä½¿ç”¨ã§ãã‚‹ãªã‚‰ `log.info()` ã®æ–¹ãŒ `print()` ã‚ˆã‚Šã‚‚ç”Ÿç”£æ€§ãŒé«˜ã„ã€‚
ãªã®ã§ã€Pythonã‚’æ›¸ãã¨ãã¯structlogã‚’ä½¿ã†ã¹ãã ã€‚

## ä¸è¶³ã—ã¦ã„ã‚‹ã‚‚ã®

ã—ã‹ã—ã€structlogã®æ¬ ç‚¹ã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ä¸è¶³ã¨ãƒ†ã‚¹ãƒˆã®ä¸è¶³ã«ã‚ã‚‹ã€‚
structlogã®å®Ÿè£…ã¨æ©Ÿèƒ½ã¯è¤‡é›‘ã§ã‚ã‚Šã€ã¾ãŸå¯¾å¿œã—ãªãã¦ã¯ãªã‚‰ãªã„ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã€ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã®çµ„ã¿åˆã‚ã›ã¯ç„¡é™ã«å­˜åœ¨ã™ã‚‹ã€‚
ã—ã‹ã‚‚ã€ãã‚Œã¯èª­ã‚€åœ°ç„ã¨ã—ã¦æ‚ªåé«˜ã„Pythonã®loggerAPIã®ãƒ©ãƒƒãƒ‘ãƒ¼ãªã®ã§ã‚ã‚‹ã€‚
ãã‚Œã‚’hynekãŒOSSã¨ã—ã¦ä¸€äººã§ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚’ã—ç¶šã‘ã¦ã„ã‚‹ã€‚å½¼ã®å‡„ã•ã¯ç­†èˆŒã«å°½ãã—ãŒãŸã„ã€‚^[æ˜”ã‹ã‚‰å‡„ã„äººãªã®ã ã‘ã‚Œã©ã‚‚]

structlogã¯production-readyã‚’è¬³ã£ã¦ãŠã‚Šã€æ™®é€šã®å‹•ä½œã®ç¯„ç–‡ã§ã¯ãƒã‚°ã¯ã»ã¼ãªãå®‰å®šã—ã¦ã„ã‚‹ã€‚
ç§ã¯å®Ÿè£…ã‚’èª­ã¿ãªãŒã‚‰ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã§éŠã‚“ã§ã„ãŸã®ã§ã€å¹¾ã¤ã‹ã‚³ãƒŸãƒƒãƒˆã‚’æŠ•ã’ã‚ˆã†ã¨æ€ã£ãŸãŒã€ä¿®æ­£ã«ã¯å…¨ä½“ã®ä»•æ§˜ã‚’æ·±ãç†è§£ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€ãƒ•ãƒ«ã‚¿ã‚¤ãƒ ã®OSSãƒ¡ãƒ³ãƒ†ãƒŠãƒ¼ã§ãªã„ã¨å³ã—ã„ã‚ˆã†ã«æ„Ÿã˜ãŸã€‚
ãªã®ã§ã€ã‚³ãƒ¼ãƒ‰ã§è²¢çŒ®ã§ããªã„ç§ã¯Github Sponsorã‚’ã—ãŸã€‚^[ã“ã®è¨˜äº‹ã¯GitHub Sponsorã®ã‚¹ãƒ†ãƒã§ã™]
[Sponsor @hynek on GitHub Sponsors](https://github.com/sponsors/hynek?frequency=recurring&sponsor=ZoraZen)
![ã‚¹ãƒãƒ³ã‚µãƒ¼ç”»é¢](/images/5e84bf93f37b1b/github_sponsor.png)

# å‚è€ƒæƒ…å ±

- ã“ã®è¨˜äº‹ã‚’æ›¸ããŸã‚ã«æ›¸ã„ãŸã‚³ãƒ¼ãƒ‰
  [ZoraZen/Structlog_in_Action](https://github.com/ZoraZen/Structlog_in_Action/)

- ãƒ­ã‚°ã®åŸºæœ¬
  [Logging HOWTO â€” Python 3.11.3 documentation](https://docs.python.org/3/howto/logging.html)

- å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
  [structlog 23.1.0 documentation](https://www.structlog.org/en/stable/)

- GitHub Sponsersã®ãƒšãƒ¼ã‚¸
  [Sponsor @hynek on GitHub Sponsors](https://github.com/sponsors/hynek?frequency=recurring&sponsor=ZoraZen)
